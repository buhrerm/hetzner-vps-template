# Hetzner VPS Full-Stack Deployment Template

A production-ready Docker Compose deployment template for TypeGraphQL + Next.js applications on Hetzner VPS with automatic GitHub deployments, SSL, and zero-downtime updates.

## 🚀 Features

- **Complete Stack**: PostgreSQL, Redis-compatible cache (Dragonfly), TypeGraphQL API, Next.js frontend
- **Auto-Deployment**: GitHub webhook handler with automatic builds and migrations
- **SSL/HTTPS**: Automatic Let's Encrypt certificate with Certbot
- **Zero-Downtime**: Rolling deployments with health checks
- **Security**: Firewall rules, fail2ban, secure secrets generation
- **Developer Friendly**: Single script deployment, comprehensive logging

## 📋 Prerequisites

- **Hetzner VPS** (or any Ubuntu 22.04+ server)
- **Domain** pointing to your server IP
- **GitHub Repositories** (2):
  - Backend: TypeGraphQL + Prisma + Bun/Node
  - Frontend: Next.js + Apollo Client
- **Root access** to the server

## 🏗️ Stack Requirements

Your repositories should follow this structure:

### Backend (TypeGraphQL + Prisma)
```
backend/
├── Dockerfile
├── package.json
├── bun.lockb (or package-lock.json)
├── prisma/
│   ├── schema.prisma
│   └── migrations/
└── src/
    └── index.ts (main server file)
```

**Dockerfile example:**
```dockerfile
FROM oven/bun:1-alpine
WORKDIR /app
COPY package*.json bun.lockb* ./
RUN bun install --frozen-lockfile
COPY . .
RUN bunx prisma generate
EXPOSE 4000
CMD ["bun", "run", "src/index.ts"]
```

### Frontend (Next.js)
```
frontend/
├── Dockerfile
├── package.json
├── bun.lockb (or package-lock.json)
├── next.config.js
└── src/ (or app/)
```

**Dockerfile example:**
```dockerfile
FROM oven/bun:1-alpine AS builder
WORKDIR /app
COPY package*.json bun.lockb* ./
RUN bun install --frozen-lockfile
COPY . .
RUN bun run build

FROM oven/bun:1-alpine
WORKDIR /app
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/public ./public
COPY --from=builder /app/package*.json ./
COPY --from=builder /app/bun.lockb* ./
RUN bun install --production
EXPOSE 3000
CMD ["bun", "run", "start"]
```

## 🚀 Quick Start

### 1. Prepare Your Server

```bash
# Connect to your server
ssh root@your-server-ip

# Clone this template
git clone https://github.com/yourusername/hetzner-vps-template.git
cd hetzner-vps-template
```

### 2. Configure Deployment

Edit the configuration section in `deploy.sh`:

```bash
# Configuration - EDIT THESE
DOMAIN="your-domain.com"
APP_NAME="yourapp"
BACKEND_REPO="git@github.com:yourusername/backend.git"
FRONTEND_REPO="git@github.com:yourusername/frontend.git"
BACKEND_REPO_NAME="YourBackend"
FRONTEND_REPO_NAME="YourFrontend"
EMAIL="your-email@example.com"
```

### 3. Run Deployment

```bash
./deploy.sh
```

The script will:
1. Install Docker and dependencies
2. Generate SSH deploy keys (you'll need to add these to GitHub)
3. Clone your repositories
4. Setup the database and run migrations
5. Configure SSL with Let's Encrypt
6. Start all services

### 4. Configure GitHub Webhooks

Add webhook to each repository:
- **Payload URL**: `https://your-domain.com/webhook`
- **Content type**: `application/json`
- **Secret**: (displayed after deployment)
- **Events**: Just the push event

## 📁 Directory Structure

```
/opt/deployment/
├── docker-compose.yml     # Service orchestration
├── .env                   # Environment variables
├── nginx/
│   └── sites-enabled/    # Nginx configuration
├── certbot/
│   ├── conf/            # SSL certificates
│   └── www/             # ACME challenge
├── webhook/
│   ├── Dockerfile       # Webhook container
│   └── webhook-server.ts # Auto-deployment handler
└── secrets/
    ├── github_deploy_key_* # SSH deploy keys
    └── webhook_secret.txt   # GitHub webhook secret

/opt/YourBackend/          # Cloned backend repository
/opt/YourFrontend/         # Cloned frontend repository
```

## 🔧 Configuration

### Environment Variables

Edit `/opt/deployment/.env`:

```env
# Application
APP_NAME=yourapp
DOMAIN=your-domain.com

# Database
DB_NAME=yourapp
DB_USER=yourapp
DB_PASSWORD=<auto-generated>
DATABASE_URL=postgresql://...

# Security
JWT_SECRET=<auto-generated>
NEXTAUTH_SECRET=<auto-generated>
GITHUB_WEBHOOK_SECRET=<auto-generated>

# Add your custom variables...
```

### Customizing Services

Edit `docker-compose.yml` to:
- Add additional services (e.g., MinIO, Elasticsearch)
- Configure resource limits
- Add health checks
- Mount additional volumes

## 🔄 Auto-Deployment Flow

1. **Push to GitHub** (main/master branch)
2. **GitHub Webhook** triggers deployment
3. **Webhook Handler**:
   - Verifies signature
   - Pulls latest code
   - Runs migrations (API only)
   - Builds new Docker image
   - Performs rolling restart
   - Health check validation

## 🛠️ Management Commands

```bash
# View logs
docker compose logs -f [service_name]

# Restart service
docker compose restart [service_name]

# Run migrations manually
docker compose run --rm api bunx prisma migrate deploy

# Database backup
docker compose exec postgres pg_dump -U yourapp yourapp > backup.sql

# Update deployment
cd /opt/YourBackend && git pull
cd /opt/YourFrontend && git pull
cd /opt/deployment
docker compose up -d --build

# SSL renewal (automatic, but can force)
docker compose run --rm certbot renew
docker compose restart nginx
```

## 🔒 Security Features

- **UFW Firewall**: Only allows SSH, HTTP, HTTPS, and webhook port
- **Fail2ban**: Protects against brute force attacks
- **SSL/TLS**: Automatic HTTPS with Let's Encrypt
- **Secrets**: Auto-generated secure passwords and tokens
- **Deploy Keys**: Separate SSH keys for each repository
- **HMAC Verification**: Webhook signatures validated

## 🐛 Troubleshooting

### Webhook Failures
```bash
docker logs deployment_webhook --tail 50
docker compose restart webhook
```

### Database Connection Issues
```bash
docker compose logs postgres
docker compose exec postgres psql -U yourapp
```

### SSL Certificate Issues
```bash
certbot certificates
docker compose run --rm certbot renew --force-renewal
```

### Migration Failures
```bash
docker compose run --rm api bunx prisma migrate status
docker compose run --rm api bunx prisma migrate resolve --applied <migration_name>
```

## 📊 Monitoring

### Service Health
```bash
curl https://your-domain.com/health
docker compose ps
```

### Resource Usage
```bash
docker stats
df -h
free -m
```

## 🔄 Updates and Maintenance

### System Updates
```bash
apt update && apt upgrade -y
docker compose pull
docker compose up -d
```

### Backup Strategy
```bash
# Database backup
docker compose exec postgres pg_dump -U yourapp yourapp > backup-$(date +%Y%m%d).sql

# Environment backup
cp /opt/deployment/.env .env.backup-$(date +%Y%m%d)
```

## 🤝 Contributing

Feel free to submit issues and pull requests to improve this template!

## 📝 License

MIT License - Use freely for your projects!

## 🙏 Acknowledgments

Built for deploying TypeGraphQL + Next.js applications on Hetzner VPS with production best practices.

---

**Note**: This template assumes you're using Bun as the JavaScript runtime. For Node.js, replace `bun` commands with `npm` or `yarn` equivalents.